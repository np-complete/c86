# 編成・補給・修理・遠征

この章では通常画面でする艦隊の操作に関するAPIを解説します。

[^fix-in-battle]: 出撃中の操作はたしか冬イベントあたりに大幅に修正されて今はもうできない

## 編成

艦隊の編成を変更するには、 `/kcsapi/api_req_hensei/change` のAPIを叩きます。
パラメータは、 第 `api_id` 艦隊の `api_ship_idx` 番目を `api_ship_id` の艦娘に変更するという形式です。
艦娘を外す場合には `api_ship_id` に `-1` を指定します。

Flashクライアントからは1つの艦隊に同じ種類の艦娘を配置できないようになっていますが、
APIでは何も制限されておらず、同じ種類どころか全く同じship_idで6隻埋めることも可能です。
今のところ伊401はイベント報酬の1隻しか無いはずですが、全員伊401で埋めることが可能ということです。

さらに、通常変更できない状況でもAPIでは何も制限しません。
出撃中[^fix-in-battle]の艦隊でも遠征中の艦隊でも変更可能です。

## 補給

艦隊に補給するには、 `/kcsapi/api_req_hokyu/charge` のAPIを叩きます。
`api_id_items` に補給する艦娘のidを `,` で繋げた文字列を指定します。

編成と同様に制限はほとんど無く、
出撃中の補給も遠征中の補給も自由です。
Flashでは1ページごとに補給しなくてはいけませんが、APIはおそらく全艦一気に補給できます[^never-tried]。

[^never-tried]: そんな恐ろしいことやったことありません

## 修理

艦娘を修理するには、 `/kcsapi/api_req_nyukyo/start` のAPIを叩きます。
パラメータには `api_dock_id` と `api_ship_id` 、バケツを使う場合は `api_highspeed` を `1` に設定します。
途中でバケツを使う場合は、 `/kcsapi/api_req_nyukyo/speedcharge` のAPIを叩きます。

もう予想できると思いますが、修理のAPIにも制限はほとんどなく、
出撃中でも遠征中でも修理できます。
ボスに到達したら全艦娘にバケツぶっかけてなんてこともできてしまいます。
唯一チェックが入るのはドックが使用済みかどうかというところだけです。

## 問題点

API設計の基本中の基本です。**必ずサーバ側で入力が正しいかチェックしましょう**。
APIのみならず、webシステムを作るときは**必ずサーバ側で入力値のチェックをしましょう**。

例えばhtml5には入力値のチェック機構が入りましたが、あれは単なる入力補助でしかありません。
javascriptで入力値のチェックをしたりすることもありますが、
それも余計なHTTPリクエストを減らしたいという目的で使うことがほとんどです。
その場合にも**必ずサーバ側で入力値のチェックをしましょう**。

## 根本的な問題

そもそも、サーバ側で入力値のチェックをしていないということは、
エンジニアがある致命的な状態に陥っていることを示しています。
それは**クライアントプログラムを信用している**という間違った思想です。

Webシステムを作る上で、**絶対にクライアントを信用してはいけません**。
HTTPの仕様上、何が正しいのか、何が正しくないのか判断することはできません。
そもそも正・不正の概念を定義することすら不可能なんじゃないでしょうか。
全ての通信は、実行するユーザには基本的に全て見えてしまうし、
それを完全再現することも容易です。
なので**絶対にクライアントを信用してはいけません**。

実際、 `IJN48` を実装する時も通信の内容を解析しかしていません。
やっていることもflashクライアントが出すリクエストと同じものを出しているだけです。
flashクライアントの逆アセンブルは多分規約で禁止されている[^reverse-compile]とおもいますが、そんなもの全く意味がないのです。

[^reverse-compile]: 昔からほとんどのソフトウェアの契約条項に逆アセ禁止が含まれている

さて、 `IJN48` とは何でしょうか?
**APIを叩くbot**でしょうか?
それとも**flashのプログラムを実行する処理系**でしょうか?
それとも**ブラウザそのもの**でしょうか?
運営の言う「正しくプレイしないとBANするぞ」の**正しいプレイ**とは何でしょうか?
本質的にそんなもの定義できないんですよ。
ネットワーク上では全ての通信が平等です。
そこには正しいとか正しくないとか無いのです。

===[column] セキュリティ設計のはなし

Webシステムの設計でクライアントを信用してはいけないように、
セキュリティの設計を考える時は、**絶対に人間を信用してはいけません**。
基本的に**人間は全員犯罪者**で**常に攻撃の機会を狙っている**と思わなければいけません。
この「人間」には、 同僚や親兄弟はおろか**自分自身も含みます**。
エンジニアは日々、**システムを知り尽くした自分ならどんな犯罪を犯すか**を想像し、
それでも攻撃できないよう、ありとあらゆる可能性を潰す、という仕事をしています。

**そりゃ病むに決まってんだろ・・・**


## まとめ: API改善ガイド

- サーバで入力値を全てチェックする
- クライアントを信用しない
- 正しいプレイなんか定義できない

とはいうものの、正しいプレイを定義する方法は実は1つだけあります。
それは指定された環境以外での実行を許可しないという方針にすることです。
艦これの場合、OSとそのバージョン、ブラウザとそのバージョン[^do-same-via-extension]、
flashプレイヤーの製造元とバージョンを指定して許可すればよいでしょう。
もちろんこれは**クソ不自由**で**Webの世界の理念に反する**ことは明らかですし、
とりあえず**Operaユーザが発狂する**姿がありありと目に浮かびます[^linux-too]。

[^do-same-via-extension]: chrome拡張で同じことをするまでです 拡張が入ったchromeでのプレイは禁止するって!? ハハ、こやつめ!
[^linux-too]: Linuxユーザが発狂する姿も見えますね・・・
